########################################
# https://rubinobs.atlassian.net/browse/{{ cookiecutter.jira_ticket_number }}
# {{ cookiecutter.project_name }}
########################################
project: {{ cookiecutter.jira_ticket_number }}
campaign: {{ cookiecutter.jira_ticket_number }}

########################################
# LSST SETUP
########################################
LSST_VERSION: ${LSST_VERSION}

########################################
# BPS VARIABLES
########################################
subDirTemplate: "{label}/{detector}"
OWNER: "lsstsvc1"

########################################
# PIPELINE CONFIGURATION
########################################
pipelineYaml: "${DRP_PIPE_DIR}/pipelines/LSSTCam/nightly-validation.yaml#step1b-single-visit-visits,step1c-single-visit-tracts,step1d-single-visit-global,stage3-coadd"

includeConfigs:
  - {{ cookiecutter.nv_root }}/{{ cookiecutter.working_dir }}/nightly-validation-LSSTCam-clustering.yaml
  - {{ cookiecutter.nv_root }}/{{ cookiecutter.working_dir }}/nightly-validation-LSSTCam-DDF.yaml

########################################
# SUBMISSION ENVIRONMENT VARIABLES
########################################
environment:
  LSST_S3_USE_THREADS: False
  LSST_RESOURCES_EXECUTOR: process
  DAF_BUTLER_CACHE_EXPIRATION_MODE: disabled

########################################
# CLUSTERING CONFIGURATION
########################################
cluster:
  step1detector:
    equalDimensions: exposure:visit
    partitionDimensions: exposure
    partitionMaxClusters: 10000
    environment:
      DAF_BUTLER_CONFIG_PATH: {{ cookiecutter.nv_root }}/{{ cookiecutter.working_dir }}/butler_config/step1:${DAF_BUTLER_CONFIG_PATH}
      DAF_BUTLER_CACHE_EXPIRATION_MODE: size=1_000_000_000_000
      DAF_BUTLER_CACHE_DIRECTORY: /lscratch/${USER}/step1_cache
  makeWarpTract:
    environment:
      DAF_BUTLER_CONFIG_PATH: {{ cookiecutter.nv_root }}/{{ cookiecutter.working_dir }}/butler_config/step3:${DAF_BUTLER_CONFIG_PATH}
      DAF_BUTLER_CACHE_EXPIRATION_MODE: datasets=500
  coadd:
    environment:
      DAF_BUTLER_CONFIG_PATH: {{ cookiecutter.nv_root }}/{{ cookiecutter.working_dir }}/butler_config/step3:${DAF_BUTLER_CONFIG_PATH}
      DAF_BUTLER_CACHE_EXPIRATION_MODE: datasets=500


########################################
# BPS PAYLOAD OPTIONS
########################################
payload:
#  payloadName: lsstcam_nightly
  inCollection: LSSTCam/runs/nightlyValidation
  output: LSSTCam/runs/nightlyValidation/{{ cookiecutter.obs_day }}/${LSST_VERSION}/{{ cookiecutter.jira_ticket_number }}
  butlerConfig: /repo/embargo+sasquatch_dev
  dataQuery: "instrument='LSSTCam' AND skymap='lsst_cells_v1' AND day_obs={{ cookiecutter.obs_day }}"


extraRunQuantumOptions: "--no-raise-on-partial-outputs"
extraQgraphOptions: --dataset-query-constraint off -c parameters:sasquatch_dataset_identifier=LSSTCam/nightlyValidation -c parameters:sasquatch_timestamp_version=explicit_timestamp:${SASQ_TIMESTAMP}T000000Z

retryUnlessExit: [2]
numberOfRetries: 3   # 5 is probably too much.
requestMemory: 4096  # reduce prob that we'll burn a retry memory

########################################
# SITE WMS CONFIGURATION
########################################
wmsServiceClass: lsst.ctrl.bps.htcondor.HTCondorService
